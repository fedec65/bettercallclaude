name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test-mcp-servers:
    name: Test MCP Servers
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18, 20, 22]
    steps:
      - uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}

      - name: Install dependencies
        working-directory: mcp-servers-src
        run: npm ci

      - name: Lint
        working-directory: mcp-servers-src
        run: npm run lint --if-present
        continue-on-error: true

      - name: Build
        working-directory: mcp-servers-src
        run: npm run build

      - name: Test
        working-directory: mcp-servers-src
        run: npm test

  validate-plugin:
    name: Validate Plugin Structure
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Check marketplace.json
        run: |
          echo "Checking .claude-plugin/marketplace.json..."
          node -e "
            const m = JSON.parse(require('fs').readFileSync('.claude-plugin/marketplace.json','utf8'));
            if (!m.name) { console.error('Missing marketplace name'); process.exit(1); }
            if (!m.owner || !m.owner.name) { console.error('Missing owner.name'); process.exit(1); }
            if (!m.plugins || !m.plugins.length) { console.error('No plugins defined'); process.exit(1); }
            m.plugins.forEach(p => {
              if (!p.name || !p.source) { console.error('Plugin missing name or source:', p); process.exit(1); }
            });
            console.log('marketplace.json OK:', m.name, '(' + m.plugins.length + ' plugins)');
          "

      - name: Check plugin.json
        run: |
          echo "Checking bettercallclaude/.claude-plugin/plugin.json..."
          node -e "
            const p = JSON.parse(require('fs').readFileSync('bettercallclaude/.claude-plugin/plugin.json','utf8'));
            const required = ['name','description','version','author'];
            const missing = required.filter(f => !p[f]);
            if (missing.length) { console.error('Missing fields:', missing); process.exit(1); }
            console.log('plugin.json OK:', p.name, 'v' + p.version);
          "

      - name: Check plugin symlinks resolve
        run: |
          for link in agents commands skills hooks mcp-servers scripts .mcp.json; do
            target="bettercallclaude/$link"
            if [ ! -e "$target" ]; then
              echo "FAIL: $target does not exist or symlink broken"
              exit 1
            fi
            echo "OK: $target"
          done

      - name: Check compiled bundles exist
        run: |
          for server in entscheidsuche bge-search legal-citations fedlex-sparql onlinekommentar; do
            if [ ! -f "mcp-servers/$server/dist/index.js" ]; then
              echo "FAIL: Missing mcp-servers/$server/dist/index.js"
              exit 1
            fi
            echo "OK: mcp-servers/$server/dist/index.js"
          done

      - name: Check .mcp.json
        run: |
          node -e "
            const m = JSON.parse(require('fs').readFileSync('.mcp.json','utf8'));
            if (!m.mcpServers) { console.error('Missing mcpServers'); process.exit(1); }
            const servers = Object.keys(m.mcpServers);
            console.log('MCP servers configured:', servers.length);
            servers.forEach(s => console.log(' -', s));
          "

      - name: Check skill frontmatter
        run: |
          for skill_dir in skills/*/; do
            skill_file="${skill_dir}SKILL.md"
            if [ ! -f "$skill_file" ]; then
              echo "FAIL: Missing $skill_file"
              exit 1
            fi
            if ! head -1 "$skill_file" | grep -q "^---"; then
              echo "FAIL: $skill_file missing YAML frontmatter"
              exit 1
            fi
            echo "OK: $skill_file"
          done

      - name: Check command frontmatter
        run: |
          for cmd in commands/*.md; do
            if ! head -1 "$cmd" | grep -q "^---"; then
              echo "FAIL: $cmd missing YAML frontmatter"
              exit 1
            fi
            echo "OK: $cmd"
          done

      - name: Check agent frontmatter
        run: |
          for agent in agents/*.md; do
            if ! head -1 "$agent" | grep -q "^---"; then
              echo "FAIL: $agent missing YAML frontmatter"
              exit 1
            fi
            echo "OK: $agent"
          done
